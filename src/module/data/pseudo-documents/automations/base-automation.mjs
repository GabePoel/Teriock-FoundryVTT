import { localizeChoices } from "../../../helpers/localization.mjs";
import { competenceField } from "../../fields/helpers/builders.mjs";
import { PropagationDataMixin } from "../../shared/mixins/_module.mjs";
import TypedPseudoDocument from "../abstract/typed-pseudo-document.mjs";

const { fields } = foundry.data;

//noinspection JSClosureCompilerSyntax
/**
 * @implements {Teriock.Models.BaseAutomationInterface}
 * @extends {TypedPseudoDocument}
 * @mixes PropagationData
 */
export default class BaseAutomation extends PropagationDataMixin(
  TypedPseudoDocument,
) {
  /** @inheritDoc */
  static LOCALIZATION_PREFIXES = [
    ...super.LOCALIZATION_PREFIXES,
    "TERIOCK.AUTOMATIONS.BaseAutomation",
  ];

  /**
   * @inheritDoc
   * @returns {{ documentName: "Automation", macro: boolean }}
   */
  static get metadata() {
    return Object.assign(super.metadata, {
      documentName: "Automation",
      macro: false,
    });
  }

  /** @inheritDoc */
  static defineSchema() {
    return Object.assign(super.defineSchema(), {
      competencies: new fields.SetField(competenceField(), {
        initial: [0, 1, 2],
      }),
      heighten: new fields.SetField(
        new fields.NumberField({
          choices: localizeChoices({
            0: "TERIOCK.AUTOMATIONS.BaseAutomation.FIELDS.heighten.choices.0",
            1: "TERIOCK.AUTOMATIONS.BaseAutomation.FIELDS.heighten.choices.1",
          }),
        }),
        {
          initial: [0, 1],
        },
      ),
    });
  }

  /**
   * Whether this is active and should be included in the overall effect.
   * @returns {boolean}
   */
  get active() {
    return this.competent;
  }

  /**
   * Buttons generated by this automation.
   * @returns {Teriock.UI.HTMLButtonConfig[]}
   */
  get buttons() {
    return [];
  }

  /**
   * Whether this can crit.
   * @returns {boolean}
   */
  get canCrit() {
    return false;
  }

  /**
   * Whether the competence requirements for this to be active are met.
   * @returns {boolean}
   */
  get competent() {
    return this.competencies.has(this.parent.competence.raw);
  }

  /**
   * Whether this is passive or not.
   * @returns {boolean}
   */
  get isPassive() {
    if (this.document.type === "ability") {
      return this.parent["maneuver"] === "passive";
    } else return this.document.type === "property";
  }
}
