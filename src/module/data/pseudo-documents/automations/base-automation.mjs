import { competenceField } from "../../fields/helpers/builders.mjs";
import TypedPseudoDocument from "../abstract/typed-pseudo-document.mjs";

const { fields } = foundry.data;

//noinspection JSClosureCompilerSyntax
/**
 * @implements {Teriock.Models.BaseAutomationInterface}
 */
export default class BaseAutomation extends TypedPseudoDocument {
  /** @inheritDoc */
  static get metadata() {
    return Object.assign(super.metadata, {
      documentName: "Automation",
    });
  }

  /** @inheritDoc */
  static defineSchema() {
    return Object.assign(super.defineSchema(), {
      competencies: new fields.SetField(competenceField(), {
        initial: [0, 1, 2],
      }),
      heighten: new fields.SetField(
        new fields.NumberField({
          choices: {
            0: "Non-Heighten",
            1: "Heighten",
          },
        }),
        {
          initial: [0, 1],
        },
      ),
    });
  }

  /**
   * Paths to forms to display in the editor.
   * @returns {string[]}
   */
  get _formPaths() {
    return [];
  }

  /**
   * Whether this is active and should be included in the overall effect.
   * @returns {boolean}
   */
  get active() {
    return this.competent;
  }

  /**
   * Buttons generated by this automation.
   * @returns {Teriock.UI.HTMLButtonConfig[]}
   */
  get buttons() {
    return [];
  }

  /**
   * Whether this can crit.
   * @returns {boolean}
   */
  get canCrit() {
    return false;
  }

  /**
   * Whether this can heighten.
   * @returns {boolean}
   */
  get canHeighten() {
    return this.document.type === "ability";
  }

  /**
   * Whether the competence requirements for this to be active are met.
   * @returns {boolean}
   */
  get competent() {
    return this.competencies.has(this.parent.competence.raw);
  }

  /**
   * Forms that go into the simple editor for this impact.
   * @returns {Promise<string>}
   */
  async _getEditorForms() {
    let html = "";
    for (const fp of this._formPaths) {
      const field = this.schema.getField(fp);
      const formGroup = field.toFormGroup(
        { rootId: this.uuid },
        {
          name: `${this.fieldPath}.${this.id}.${fp}`,
          value: foundry.utils.getProperty(this, fp),
        },
      );
      html += formGroup.outerHTML;
    }
    return html;
  }

  /**
   * A simple editor for this impact.
   * @returns {Promise<string>}
   */
  async getEditor() {
    return this._getEditorForms();
  }
}
