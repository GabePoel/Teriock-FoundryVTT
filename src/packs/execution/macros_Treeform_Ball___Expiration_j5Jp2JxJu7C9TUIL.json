{
  "name": "Treeform Ball - Expiration",
  "type": "script",
  "_id": "j5Jp2JxJu7C9TUIL",
  "author": "Z8sCTHO0edFF1hYo",
  "img": "icons/svg/dice-target.svg",
  "scope": "global",
  "command": "const data = /** @type {Teriock.HookData.EffectActivity} */ scope.data;\nif (\n  data.doc.name === \"Treeform Ball Effect\" &&\n  actor.itemKeys.species.has(\"tree\")\n) {\n  let hp = actor.getFlag(\"teriock\", \"preTransformHp\") || 0;\n  if (hp) {\n    if (actor.system.hp.value < 0) {\n      hp += actor.system.hp.value;\n    }\n  }\n  const tree = actor.species.find((s) => s.name === \"Tree\");\n  if (tree) {\n    await tree.delete();\n  }\n  const speciesUpdates = actor.species.map((s) => {\n    return {\n      _id: s.id,\n      \"system.applyHp\": s.getFlag(\"teriock\", \"preTreeformApplyHp\"),\n      \"system.disabled\": s.getFlag(\"teriock\", \"preTreeformDisabled\"),\n    };\n  });\n  const rankUpdates = actor.ranks.map((r) => {\n    return {\n      _id: r.id,\n      \"system.applyHp\": r.getFlag(\"teriock\", \"preTreeformApplyHp\"),\n      \"system.disabled\": r.getFlag(\"teriock\", \"preTreeformDisabled\"),\n    };\n  });\n  await actor.updateEmbeddedDocuments(\"Item\", [\n    ...speciesUpdates,\n    ...rankUpdates,\n  ]);\n  await actor.update({ \"system.hp.value\": hp });\n  await actor.unsetFlag(\"teriock\", \"preTransformHp\");\n}",
  "folder": null,
  "sort": 0,
  "ownership": {
    "default": 0,
    "Z8sCTHO0edFF1hYo": 3
  },
  "flags": {},
  "_stats": {
    "compendiumSource": null,
    "duplicateSource": null,
    "exportSource": null,
    "coreVersion": "13.345",
    "systemId": "teriock",
    "systemVersion": "0.1.0",
    "createdTime": 1756418843951,
    "modifiedTime": 1756589479385,
    "lastModifiedBy": "Z8sCTHO0edFF1hYo"
  },
  "_key": "!macros!j5Jp2JxJu7C9TUIL"
}
