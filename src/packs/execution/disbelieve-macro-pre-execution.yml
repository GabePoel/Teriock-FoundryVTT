name: Disbelieve Macro - Pre-execution
type: script
_id: 5Gvsoxg0CvvGNUeA
author: teriockBuilder00
img: icons/svg/dice-target.svg
scope: global
command: |-
  const data = /** @type {Teriock.HookData.UseAbility} */ scope.data;
  const illusionLevels = {
    minor: "Minor Illusion",
    full: "Full Illusion",
    greater: "Greater Illusion",
  };
  const chosenIllusionLevel = await tm.dialogs.selectDialog(
    illusionLevels,
    {
      label: "Level",
      hint: "If known, select the level of illusion you are attempting to disbelieve.",
      hintHtml: TERIOCK.content.keywords.illusionary,
      hintTitle: "Illusionary",
      title: "Select Illusion Level",
      other: true,
      initial: "minor",
    },
  );
  let dc = "none";
  if (chosenIllusionLevel === "minor") dc = 6;
  if (chosenIllusionLevel === "full") dc = 12;
  if (chosenIllusionLevel === "greater") dc = 18;
  const buttons = data.rollConfig.chatData.system.buttons.filter(
    (b) => b.dataset?.action === "feat-save" && b.dataset?.attribute === "int",
  );
  if (typeof dc === "number") {
    for (const b of buttons) {
      b.dataset.dc = `${dc - 2 * data.rollConfig.useData.modifiers.heightened}`;
    }
  }
  for (let i = 0; i < data.rollConfig.chatData.rolls.length; i++) {
    const r = data.rollConfig.chatData.rolls[i];
    if (r.context?.diceClass === "feat") {
      if (typeof dc === "number") {
        const newRoll = new game.teriock.Roll(
          `${dc} - 2 * @h`,
          data.rollConfig.useData.rollData,
          {
            flavor: illusionLevels[chosenIllusionLevel] + " DC",
            context: {
              diceClass: "feat",
              totalClass: "feat",
            },
          },
        );
        await newRoll.evaluate();
        data.rollConfig.chatData.rolls[i] = newRoll;
      } else {
        data.rollConfig.chatData.rolls.pop();
      }
    }
  }
folder: null
ownership:
  default: 0
flags: {}
_stats:
  coreVersion: '13'
  systemId: teriock
  systemVersion: 0.1.0
  lastModifiedBy: teriockBuilder00
_key: '!macros!5Gvsoxg0CvvGNUeA'
