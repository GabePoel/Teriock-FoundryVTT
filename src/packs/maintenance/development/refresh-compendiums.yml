_id: c65e729ad2ff19f2
_key: '!macros!c65e729ad2ff19f2'
_stats:
  coreVersion: '13'
  lastModifiedBy: teriockBuilder00
  systemId: teriock
  systemVersion: 0.9.17
author: teriockBuilder00
command: |-
  await tm.utils.progressBar(
    await tm.dialogs.selectCompendiumsDialog(),
    game.i18n.localize("TERIOCK.DIALOGS.RefreshCompendium.messageUnnamed"),
    /** @param {TeriockCompendiumCollection<TeriockDocument>} p */ async (p) => {
      if (!p.locked) {
        await p.getIndex();
        const indexes = tm.sort.docSort(
          p.index.contents.filter((d) => !d?.system?._sup),
        );
        await tm.utils.progressBar(
          indexes,
          game.i18n.format("TERIOCK.DIALOGS.RefreshCompendium.messageNamed", {
            name: game.i18n.localize(p.title),
          }),
          async (i) => {
            const doc = await tm.resolve.resolveDocument(i);
            await doc.update({
              "system.identifier": doc.defaultIdentifier,
            });
            if (typeof doc?.system?.refreshFromCompendiumSource === "function") {
              const options = {};
              if (p.collection === "teriock.magicItems") {
                options.deleteChildren = false;
                options.recursive = false;
              }
              await doc.system.refreshFromCompendiumSource(options);
              if (p.collection === "teriock.magicItems") {
                for (const child of await doc.getChildArray()) {
                  await child.system.refreshFromCompendiumSource();
                }
              }
            }
          },
          { batch: 20 },
        );
      }
    },
  );
folder: 35429c9dc2319aea
img: icons/svg/portal.svg
name: Refresh Compendiums
scope: global
type: script
