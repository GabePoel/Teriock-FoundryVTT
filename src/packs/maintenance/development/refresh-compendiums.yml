_id: refreshCompendiu
_key: '!macros!refreshCompendiu'
_stats:
  coreVersion: '13'
  lastModifiedBy: teriockBuilder00
  systemId: teriock
  systemVersion: 0.9.16
author: teriockBuilder00
command: |-
  await tm.utils.progressBar(
    await tm.dialogs.selectCompendiumsDialog(),
    "Refreshing Compendiums",
    /** @param {TeriockCompendiumCollection<TeriockDocument>} p */ async (p) => {
      if (!p.locked) {
        await p.getIndex();
        const indexes = tm.sort.docSort(
          p.index.contents.filter((d) => !d?.system?._sup),
        );
        await tm.utils.progressBar(
          indexes,
          `Refreshing ${p.title}`,
          async (i) => {
            const doc = await tm.resolve.resolveDocument(i);
            if (typeof doc?.system?.refreshFromCompendiumSource === "function") {
              const options = {};
              if (p.collection === "teriock.magicItems") {
                options.deleteChildren = false;
                options.recursive = false;
              }
              await doc.system.refreshFromCompendiumSource(options);
              if (p.collection === "teriock.magicItems") {
                for (const child of await doc.getChildArray()) {
                  await child.system.refreshFromCompendiumSource();
                }
              }
            }
          },
          { batch: 20 },
        );
      }
    },
  );
folder: development00000
img: icons/svg/portal.svg
name: Refresh Compendiums
scope: global
type: script
