<div class="ch-battle-box tbox toutline">
  <div class="defense-box">
    <div class="defense-box-main">
      <div class="character-shortbox character-ac-box">
        <div class="tsubtle tcenter">AC</div>
        <div class="character-smallbox-value" data-tooltip="Armor Class">
          {{{system.ac}}}
        </div>
      </div>

      <div class="character-shortbox character-bv-box">
        <div class="tsubtle tcenter">BV</div>
        <div class="character-smallbox-value" data-tooltip="Block Value">
          {{{system.bv}}}
        </div>
      </div>

      <div class="character-shortbox character-cc-box">
        <div class="tsubtle tcenter">AC + BV</div>
        <div class="character-smallbox-value" data-tooltip="Combined AC and BV">
          {{{system.cc}}}
        </div>
      </div>
    </div>

    <div class="character-primary-blocker" style="width: 100%;">
      <div class="tsubtle little-title">
        <div class="title-left">Blocking With</div>
        <div class="title-right">
          <i
            class="fa-regular fa-dice-d20 thover"
            data-action="resist"
            data-tooltip="Roll Resistance Save"
          ></i>
          <i
            class="fa-regular fa-dice-d4 thover"
            data-action="endCondition"
            data-tooltip="Roll End Condition"
          ></i>
          {{#if (exists system.wielding.blocker.derived)}}
            <i
              class="fa-regular fa-arrow-up-right-from-square thover"
              data-action="openPrimaryBlocker"
              data-tooltip="Open"
            ></i>
          {{/if}}
        </div>
      </div>
      <div
        class="thover character-primary-blocker-select"
        data-tooltip="Block Item"
      >
        {{#if (exists system.wielding.blocker.derived)}}
          {{{system.wielding.blocker.derived.name}}}
        {{else}}
          None
        {{/if}}
      </div>
    </div>
  </div>

  <div class="reaction-box defense-box" style="align-items: center; flex-direction: row;" data-action="toggleReaction">
    <div class="title-left tsubtle">Has Reaction</div>
    <div class="right-container" style="display: flex; align-items: center; justify-content: end; flex: 1;">
      <div class="character-smallbox-value" data-tooltip="Toggle Reaction">
        {{#if system.hasReaction}}
          <i class="fa-solid fa-check thover"></i>
        {{else}}
          <i class="fa-solid fa-xmark thover"></i>
        {{/if}}
      </div>
    </div>
  </div>

  <div class="attack-box">
    <div class="attack-box-main">
      <div class="character-shortbox character-piercing-box">
        <div class="tsubtle tcenter" data-action="piercingChange">Piercing</div>
        <div class="character-smallbox-value thover" data-tooltip="Override Piercing">
          {{#if (or (eq system.piercing "ub") system.wielding.attacker.derived.system.derivedUb)}}
            UB{{#if (eq system.piercing "ub")}}*{{/if}}
          {{else}}
            {{#if (or (eq system.piercing "av0") system.wielding.attacker.derived.system.derivedAv0)}}
              AV0{{#if (eq system.piercing "av0")}}*{{/if}}
            {{else}}
              <i class="fa-solid fa-xmark thover"></i>
            {{/if}}
          {{/if}}
        </div>
      </div>

      <div class="character-shortbox character-sb-box" data-action="toggleSb">
        <div class="tsubtle tcenter">SB</div>
        <div class="character-smallbox-value" data-tooltip="Toggle Style Bonus">
          {{#if system.sb}}
            <i class="fa-solid fa-check thover"></i>
          {{else}}
            <i class="fa-solid fa-xmark thover"></i>
          {{/if}}
        </div>
      </div>

      <div class="character-shortbox character-penalty-box">
        <div class="tsubtle tcenter">Penalty</div>
        {{formInput
          systemFields.attackPenalty
          value=system.attackPenalty
          classes="character-penalty-input character-smallbox-value"
          dataset=(object tooltip="Change Attack Penalty")
        }}
      </div>
    </div>

    <div class="character-primary-attacker" style="width: 100%;">
      <div class="tsubtle little-title">
        <div class="title-left">Attacking With</div>
        <div class="title-right">
          <i
            class="fa-regular fa-dice-d20 thover"
            data-action="attack"
            data-id="{{system.wielding.attacker.derived._id}}"
            data-tooltip="Roll Attack"
          ></i>
          {{#if (exists system.wielding.attacker.derived)}}
            <i
              class="fa-regular fa-hammer-crash thover"
              data-action="quickUse"
              data-id="{{system.wielding.attacker.derived._id}}"
              data-tooltip="Roll Damage"
            ></i>
            <i
              class="fa-regular fa-arrow-up-right-from-square thover"
              data-action="openPrimaryAttacker"
              data-tooltip="Open"
            ></i>
          {{/if}}
        </div>
      </div>

      <div
        class="thover character-primary-attacker-select"
        data-tooltip="Attack Item"
      >
        {{#if (exists system.wielding.attacker.derived)}}
          {{{system.wielding.attacker.derived.name}}}
        {{else}}
          None
        {{/if}}
      </div>

      {{#if (exists system.wielding.attacker.derived.system.specialRules)}}
        <div class="tsubtle little-title" style="margin-top: 0.5em;">
          {{path
            TERIOCK.index.weaponFightingStyles
            system.wielding.attacker.derived.system.sb
          }} Fighting Style
        </div>
        <div>
          {{editor enrichedSpecialRules button=false editable=false}}
        </div>
      {{/if}}
    </div>
  </div>
</div>
