<div class="ch-battle-box tbox toutline">
  <div class="defense-box">
    <div class="defense-box-main">
      <div class="character-shortbox character-ac-box">
        <div class="tsubtle tcenter">AC</div>
        <div class="character-smallbox-value" data-tooltip="Armor Class">
          {{{system.defense.ac}}}
        </div>
      </div>

      <div class="character-shortbox character-bv-box">
        <div class="tsubtle tcenter">BV</div>
        <div class="character-smallbox-value" data-tooltip="Block Value">
          {{{system.defense.bv}}}
        </div>
      </div>

      <div class="character-shortbox character-cc-box">
        <div class="tsubtle tcenter">AC + BV</div>
        <div class="character-smallbox-value" data-tooltip="Combined AC and BV">
          {{{system.defense.cc}}}
        </div>
      </div>
    </div>

    <div
      class="character-primary-blocker"
      style="width: 100%;"
      data-action="selectBlocker"
    >
      <div class="tsubtle little-title">
        <div class="title-left">Blocking With</div>
        <div class="title-right">
          <i
            class="fa-regular fa-dice-d20 thover"
            data-action="rollResistance"
            data-tooltip="Roll Resistance Save"
          ></i>
          {{#if (exists system.primaryBlocker)}}
            <i
              class="fa-regular fa-shield thover"
              data-action="useAbility"
              data-ability="Basic Block"
              data-tooltip="Roll Block"
            ></i>
            <i
              class="fa-regular fa-arrow-up-right-from-square thover"
              data-action="openPrimaryBlocker"
              data-tooltip="Open"
            ></i>
          {{/if}}
        </div>
      </div>
      <div
        class="thover character-primary-blocker-select draggable"
        data-make-tooltip="true"
        data-tooltip-direction="LEFT"
        data-tooltip-left="true"
        {{#if (exists system.primaryBlocker)}}
        data-uuid="{{system.primaryBlocker.uuid}}"
        {{/if}}
      >
        {{#if (exists system.primaryBlocker)}}
          {{{system.primaryBlocker.name}}}
        {{else}}
          None
        {{/if}}
      </div>
    </div>
  </div>

  <div
    class="defense-box middle-box"
    style="flex-direction: row; width: 100%; gap: 0.5em;"
  >
    <div
      class="reaction-box"
      style="display: flex; align-items: center; flex-direction: row; width: 57%"
      data-action="toggleReaction"
    >
      <div class="title-left tsubtle">Has Reaction</div>
      <div
        class="right-container"
        style="display: flex; align-items: center; justify-content: end; flex: 1;"
      >
        <div
          class="character-smallbox-value"
          data-tooltip="Toggle Reaction"
        >
          {{#if system.combat.hasReaction}}
            <i class="fa-solid fa-check thover"></i>
          {{else}}
            <i class="fa-solid fa-xmark thover"></i>
          {{/if}}
        </div>
      </div>
    </div>
    <div class="cover-box" data-action="increaseCover">
      <div class="title-left tsubtle">Cover</div>
      <div
        class="right-container"
        style="display: flex; align-items: center; justify-content: end; flex: 1;"
      >
        {{#if (eq system.cover 0)}}<i class="fa-fw fa-regular fa-tree thover" data-tooltip="No Cover"></i>{{/if}}
        {{#if (eq system.cover 1)}}<i class="fa-fw fa-regular fa-duotone fa-tree thover" data-tooltip="Half
        Cover"></i>{{/if}}
        {{#if (eq system.cover 2)}}<i class="fa-fw fa-solid fa-tree thover" data-tooltip="Three-Quarters
      Cover"></i>{{/if}}
        {{#if (eq system.cover 3)}}<i class="fa-fw fa-solid fa-trees thover" data-tooltip="Full Cover"></i>{{/if}}
      </div>
    </div>
  </div>

  <div class="attack-box">
    <div class="attack-box-main">
      <div class="character-shortbox character-piercing-box">
        <div class="tsubtle tcenter" data-action="piercingChange">Piercing</div>
        <div
          class="character-smallbox-value thover"
          data-tooltip="Override Piercing"
        >
          {{#if
            (or
              (eq system.offense.piercing "ub")
              system.primaryAttacker.system.piercing.ub
            )
          }}
            UB{{#if (eq system.offense.piercing "ub")}}*{{/if}}
          {{else}}
            {{#if
              (or
                (eq system.offense.piercing "av0")
                system.primaryAttacker.system.piercing.av0
              )
            }}
              AV0{{#if (eq system.offense.piercing "av0")}}*{{/if}}
            {{else}}
              <i class="fa-solid fa-xmark thover"></i>
            {{/if}}
          {{/if}}
        </div>
      </div>

      <div class="character-shortbox character-sb-box" data-action="toggleSb">
        <div class="tsubtle tcenter">SB</div>
        <div class="character-smallbox-value" data-tooltip="Toggle Style Bonus">
          {{#if system.offense.sb}}
            <i class="fa-solid fa-check thover"></i>
          {{else}}
            <i class="fa-solid fa-xmark thover"></i>
          {{/if}}
        </div>
      </div>

      <div class="character-shortbox character-penalty-box">
        <div class="tsubtle tcenter">Penalty</div>
        {{formInput
          systemFields.combat.fields.attackPenalty
          value=system.combat.attackPenalty
          classes="character-penalty-input character-smallbox-value"
          dataset=(object tooltip="Change Attack Penalty")
        }}
      </div>
    </div>

    <div
      class="character-primary-attacker"
      style="width: 100%;"
      data-action="selectAttacker"
    >
      <div class="tsubtle little-title">
        <div class="title-left">Attacking With</div>
        <div class="title-right">
          <i
            class="fa-regular fa-dice-d20 thover"
            data-action="useAbility"
            data-ability="Basic Attack"
            data-tooltip="Roll Attack"
          ></i>
          {{#if (exists system.primaryAttacker)}}
            <i
              class="fa-regular fa-hammer-crash thover"
              data-action="quickUse"
              data-id="{{system.primaryAttacker._id}}"
              data-tooltip="Roll Damage"
            ></i>
            <i
              class="fa-regular fa-arrow-up-right-from-square thover"
              data-action="openPrimaryAttacker"
              data-tooltip="Open"
            ></i>
          {{/if}}
        </div>
      </div>

      <div
        class="thover character-primary-attacker-select draggable"
        data-make-tooltip="true"
        data-tooltip-direction="LEFT"
        data-tooltip-left="true"
        {{#if (exists system.primaryAttacker)}}
        data-uuid="{{system.primaryAttacker.uuid}}"
        {{/if}}
      >
        {{#if (exists system.primaryAttacker)}}
          {{{system.primaryAttacker.name}}}
        {{else}}
          None
        {{/if}}
      </div>

      {{#if (exists system.primaryAttacker.system.specialRules)}}
        <div class="tsubtle little-title" style="margin-top: 0.5em;">
          {{path
            TERIOCK.index.weaponFightingStyles
            system.primaryAttacker.system.fightingStyle
          }}
          Fighting Style
        </div>
        <div>
          {{editor enrichedSpecialRules button=false editable=false}}
        </div>
      {{/if}}
    </div>
  </div>
</div>